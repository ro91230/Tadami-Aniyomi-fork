name: CI

permissions:
  contents: write

on:
  push:
    branches:
      - '*'
    tags:
      - v*

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    name: Build app
    runs-on: ubuntu-latest

    steps:
      - name: Clone repo
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      - name: Set up Node
        uses: actions/setup-node@60edb5dd545a775178f52524783378180af0d1f8 # v4.2.0
        with:
          node-version: '22'

      - name: Collect changed files
        shell: bash
        run: |
          set -euo pipefail
          if [ "${{ github.event.before }}" = "0000000000000000000000000000000000000000" ]; then
            git diff-tree --no-commit-id --name-only -r "${{ github.sha }}" > changed_files.txt
          else
            git diff --name-only "${{ github.event.before }}" "${{ github.sha }}" > changed_files.txt
          fi
          echo "Changed files:"
          cat changed_files.txt

      - name: Detect reading-critical changes
        id: reading_changes
        shell: bash
        run: |
          set -euo pipefail
          node tools/ci/detect-reading-critical.js --input changed_files.txt --github-output "$GITHUB_OUTPUT"

      - name: Set up JDK
        uses: actions/setup-java@3a4f6e1af504cf6a31855fa899c6aa5355ba6c12 # v4.7.0
        with:
          java-version: 17
          distribution: temurin

      - name: Set up gradle
        uses: gradle/actions/setup-gradle@94baf225fe0a508e581a564467443d0e2379123b # v4.3.0

      - name: Check code format
        run: ./gradlew spotlessCheck

      - name: Build app
        run: |
          set -euo pipefail
          ./gradlew assembleRelease -Penable-updater --console=plain 2>&1 | tee build_release.log
          python3 tools/ci/report-release-warnings.py build_release.log --enforce

      - name: Run unit tests
        run: ./gradlew testReleaseUnitTest --stacktrace --console=plain

      - name: Print unit test failures
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          results_dir="app/build/test-results/testReleaseUnitTest"
          if [ ! -d "$results_dir" ]; then
            echo "No test results directory found: $results_dir"
            exit 0
          fi
          python3 - <<'PY'
          import glob
          import xml.etree.ElementTree as ET

          files = sorted(glob.glob("app/build/test-results/testReleaseUnitTest/*.xml"))
          if not files:
              print("No JUnit XML files found in app/build/test-results/testReleaseUnitTest")
              raise SystemExit(0)

          failures = []
          total_tests = total_failures = total_errors = 0

          for path in files:
              root = ET.parse(path).getroot()
              total_tests += int(root.attrib.get("tests", 0))
              total_failures += int(root.attrib.get("failures", 0))
              total_errors += int(root.attrib.get("errors", 0))
              suite_name = root.attrib.get("name", "")
              for case in root.findall("testcase"):
                  failure = case.find("failure")
                  error = case.find("error")
                  if failure is None and error is None:
                      continue
                  node = failure if failure is not None else error
                  classname = case.attrib.get("classname", suite_name)
                  testname = case.attrib.get("name", "<unknown>")
                  message = (node.attrib.get("message") or "").strip()
                  text = (node.text or "").strip().splitlines()
                  detail = message or (text[0].strip() if text else "No details")
                  failures.append((classname, testname, detail))

          print(f"Unit test summary: tests={total_tests}, failures={total_failures}, errors={total_errors}")
          if not failures:
              print("No failed tests found in JUnit XML.")
          else:
              print("Failed tests:")
              for classname, testname, detail in failures:
                  print(f"- {classname} > {testname}: {detail}")
          PY

      - name: Upload unit test reports
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: unit-test-release-report-${{ github.sha }}
          if-no-files-found: warn
          path: |
            app/build/reports/tests/testReleaseUnitTest
            app/build/test-results/testReleaseUnitTest

      - name: Reading regression unit matrix
        if: steps.reading_changes.outputs.reading_critical == 'true'
        run: bash tools/ci/run-reading-regression-tests.sh

      - name: Reading debug assemble smoke
        if: steps.reading_changes.outputs.reading_critical == 'true'
        run: ./gradlew :app:assembleDebug

      - name: Reading gate skipped (non-reading change)
        if: steps.reading_changes.outputs.reading_critical != 'true'
        run: echo "reading_critical=false, strict reading regression matrix skipped."

      - name: Upload APK
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: arm64-v8a-${{ github.sha }}
          path: app/build/outputs/apk/release/app-arm64-v8a-release-unsigned.apk

      - name: Upload mapping
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: mapping-${{ github.sha }}
          path: app/build/outputs/mapping/release

      # Sign APK and create release for tags

      - name: Get tag name

        if: startsWith(github.ref, 'refs/tags/') && github.repository == 'aniyomiorg/aniyomi'
        run: |
          set -x
          echo "VERSION_TAG=${GITHUB_REF/refs\/tags\//}" >> $GITHUB_ENV

      - name: Sign APK
        if: startsWith(github.ref, 'refs/tags/') && github.repository == 'aniyomiorg/aniyomi'
        uses: r0adkll/sign-android-release@f30bdd30588842ac76044ecdbd4b6d0e3e813478
        with:
          releaseDirectory: app/build/outputs/apk/release
          signingKeyBase64: ${{ secrets.SIGNING_KEY }}
          alias: ${{ secrets.ALIAS }}
          keyStorePassword: ${{ secrets.KEY_STORE_PASSWORD }}
          keyPassword: ${{ secrets.KEY_PASSWORD }}
        env:
          BUILD_TOOLS_VERSION: '35.0.1'

      - name: Clean up build artifacts
        if: startsWith(github.ref, 'refs/tags/') && github.repository == 'aniyomiorg/aniyomi'
        run: |
          set -e

          mv app/build/outputs/apk/release/app-universal-release-unsigned-signed.apk aniyomi-${{ env.VERSION_TAG }}.apk
          sha=`sha256sum aniyomi-${{ env.VERSION_TAG }}.apk | awk '{ print $1 }'`
          echo "APK_UNIVERSAL_SHA=$sha" >> $GITHUB_ENV

          mv app/build/outputs/apk/release/app-arm64-v8a-release-unsigned-signed.apk aniyomi-arm64-v8a-${{ env.VERSION_TAG }}.apk
          sha=`sha256sum aniyomi-arm64-v8a-${{ env.VERSION_TAG }}.apk | awk '{ print $1 }'`
          echo "APK_ARM64_V8A_SHA=$sha" >> $GITHUB_ENV

          mv app/build/outputs/apk/release/app-armeabi-v7a-release-unsigned-signed.apk aniyomi-armeabi-v7a-${{ env.VERSION_TAG }}.apk
          sha=`sha256sum aniyomi-armeabi-v7a-${{ env.VERSION_TAG }}.apk | awk '{ print $1 }'`
          echo "APK_ARMEABI_V7A_SHA=$sha" >> $GITHUB_ENV

          mv app/build/outputs/apk/release/app-x86-release-unsigned-signed.apk aniyomi-x86-${{ env.VERSION_TAG }}.apk
          sha=`sha256sum aniyomi-x86-${{ env.VERSION_TAG }}.apk | awk '{ print $1 }'`
          echo "APK_X86_SHA=$sha" >> $GITHUB_ENV

          mv app/build/outputs/apk/release/app-x86_64-release-unsigned-signed.apk aniyomi-x86_64-${{ env.VERSION_TAG }}.apk
          sha=`sha256sum aniyomi-x86_64-${{ env.VERSION_TAG }}.apk | awk '{ print $1 }'`
          echo "APK_X86_64_SHA=$sha" >> $GITHUB_ENV

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/') && github.repository == 'aniyomiorg/aniyomi'
        uses: softprops/action-gh-release@c95fe1489396fe8a9eb87c0abf8aa5b2ef267fda # v2.2.1
        with:
          tag_name: ${{ env.VERSION_TAG }}
          name: Aniyomi ${{ env.VERSION_TAG }}
          body: |
            ---

            ### Checksums

            | Variant | SHA-256 |
            | ------- | ------- |
            | Universal | ${{ env.APK_UNIVERSAL_SHA }}
            | arm64-v8a | ${{ env.APK_ARM64_V8A_SHA }}
            | armeabi-v7a | ${{ env.APK_ARMEABI_V7A_SHA }}
            | x86 | ${{ env.APK_X86_SHA }}
            | x86_64 | ${{ env.APK_X86_64_SHA }} |
          files: |
            aniyomi-${{ env.VERSION_TAG }}.apk
            aniyomi-arm64-v8a-${{ env.VERSION_TAG }}.apk
            aniyomi-armeabi-v7a-${{ env.VERSION_TAG }}.apk
            aniyomi-x86-${{ env.VERSION_TAG }}.apk
            aniyomi-x86_64-${{ env.VERSION_TAG }}.apk
          draft: true
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
