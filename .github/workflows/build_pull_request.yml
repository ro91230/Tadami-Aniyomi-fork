name: PR build check
on:
  pull_request:
    branches:
      - main
    paths:
      - '**'
      - '!**.md'
      - '!i18n/src/commonMain/moko-resources/**/strings-aniyomi.xml'
      - '!i18n/src/commonMain/moko-resources/**/strings.xml'
      - '!i18n/src/commonMain/moko-resources/**/plurals-aniyomi.xml'
      - '!i18n/src/commonMain/moko-resources/**/plurals.xml'
      - 'i18n/src/commonMain/moko-resources/base/strings-aniyomi.xml'
      - 'i18n/src/commonMain/moko-resources/base/strings.xml'
      - 'i18n/src/commonMain/moko-resources/base/plurals-aniyomi.xml'
      - 'i18n/src/commonMain/moko-resources/base/plurals.xml'


concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  build:
    name: Build app
    runs-on: 'ubuntu-24.04'

    steps:
      - name: Clone repo
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up JDK
        uses: actions/setup-java@3a4f6e1af504cf6a31855fa899c6aa5355ba6c12 # v4.7.0
        with:
          java-version: 17
          distribution: temurin

      - name: Set up gradle
        uses: gradle/actions/setup-gradle@94baf225fe0a508e581a564467443d0e2379123b # v4.3.0

      - name: Check code format
        run: ./gradlew spotlessCheck

      - name: Build app
        run: |
          set -euo pipefail
          ./gradlew assembleRelease --console=plain 2>&1 | tee build_release.log
          python3 tools/ci/report-release-warnings.py build_release.log --enforce

      - name: Run unit tests
        run: ./gradlew testReleaseUnitTest --stacktrace --console=plain

      - name: Print unit test failures
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          results_dir="app/build/test-results/testReleaseUnitTest"
          if [ ! -d "$results_dir" ]; then
            echo "No test results directory found: $results_dir"
            exit 0
          fi
          python3 - <<'PY'
          import glob
          import xml.etree.ElementTree as ET

          files = sorted(glob.glob("app/build/test-results/testReleaseUnitTest/*.xml"))
          if not files:
              print("No JUnit XML files found in app/build/test-results/testReleaseUnitTest")
              raise SystemExit(0)

          failures = []
          total_tests = total_failures = total_errors = 0

          for path in files:
              root = ET.parse(path).getroot()
              total_tests += int(root.attrib.get("tests", 0))
              total_failures += int(root.attrib.get("failures", 0))
              total_errors += int(root.attrib.get("errors", 0))
              suite_name = root.attrib.get("name", "")
              for case in root.findall("testcase"):
                  failure = case.find("failure")
                  error = case.find("error")
                  if failure is None and error is None:
                      continue
                  node = failure if failure is not None else error
                  classname = case.attrib.get("classname", suite_name)
                  testname = case.attrib.get("name", "<unknown>")
                  message = (node.attrib.get("message") or "").strip()
                  text = (node.text or "").strip().splitlines()
                  detail = message or (text[0].strip() if text else "No details")
                  failures.append((classname, testname, detail))

          print(f"Unit test summary: tests={total_tests}, failures={total_failures}, errors={total_errors}")
          if not failures:
              print("No failed tests found in JUnit XML.")
          else:
              print("Failed tests:")
              for classname, testname, detail in failures:
                  print(f"- {classname} > {testname}: {detail}")
          PY

      - name: Upload unit test reports
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: unit-test-release-report-${{ github.sha }}
          if-no-files-found: warn
          path: |
            app/build/reports/tests/testReleaseUnitTest
            app/build/test-results/testReleaseUnitTest

      - name: Upload APK
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: arm64-v8a-${{ github.sha }}
          path: app/build/outputs/apk/release/app-arm64-v8a-release-unsigned.apk

      - name: Upload mapping
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: mapping-${{ github.sha }}
          path: app/build/outputs/mapping/release

  reading_regression_gate:
    name: Reading Regression Gate
    needs: build
    runs-on: 'ubuntu-24.04'

    steps:
      - name: Clone repo
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      - name: Set up Node
        uses: actions/setup-node@60edb5dd545a775178f52524783378180af0d1f8 # v4.2.0
        with:
          node-version: '22'

      - name: Collect changed files
        shell: bash
        run: |
          set -euo pipefail
          git diff --name-only "${{ github.event.pull_request.base.sha }}" "${{ github.event.pull_request.head.sha }}" > changed_files.txt
          echo "Changed files:"
          cat changed_files.txt

      - name: Detect reading-critical changes
        id: reading_changes
        shell: bash
        run: |
          set -euo pipefail
          node tools/ci/detect-reading-critical.js --input changed_files.txt --github-output "$GITHUB_OUTPUT"

      - name: Print reading-critical matches
        shell: bash
        run: |
          set -euo pipefail
          echo "reading_critical=${{ steps.reading_changes.outputs.reading_critical }}"
          if [ "${{ steps.reading_changes.outputs.reading_critical }}" = "true" ]; then
            echo "Matched paths:"
            printf '%s\n' "${{ steps.reading_changes.outputs.matched_paths }}"
          fi

      - name: Set up JDK
        if: steps.reading_changes.outputs.reading_critical == 'true'
        uses: actions/setup-java@3a4f6e1af504cf6a31855fa899c6aa5355ba6c12 # v4.7.0
        with:
          java-version: 17
          distribution: temurin

      - name: Set up gradle
        if: steps.reading_changes.outputs.reading_critical == 'true'
        uses: gradle/actions/setup-gradle@94baf225fe0a508e581a564467443d0e2379123b # v4.3.0

      - name: Enforce manual reading smoke declaration
        if: steps.reading_changes.outputs.reading_critical == 'true'
        env:
          PR_BODY: ${{ github.event.pull_request.body }}
        shell: bash
        run: |
          set -euo pipefail
          printf '%s' "${PR_BODY:-}" > pr_body.txt
          node tools/ci/validate-reading-smoke.js --pr-body-file pr_body.txt

      - name: Reading regression unit matrix
        if: steps.reading_changes.outputs.reading_critical == 'true'
        run: bash tools/ci/run-reading-regression-tests.sh

      - name: Reading debug assemble smoke
        if: steps.reading_changes.outputs.reading_critical == 'true'
        run: ./gradlew :app:assembleDebug

      - name: Reading gate skipped (non-reading change)
        if: steps.reading_changes.outputs.reading_critical != 'true'
        run: echo "reading_critical=false, strict reading regression matrix skipped."
