name: Novel Plugin Compatibility Nightly

on:
  schedule:
    - cron: "30 2 * * *"
  workflow_dispatch:

permissions:
  contents: read

jobs:
  compat:
    name: Run LNReader Plugin Compat
    runs-on: ubuntu-latest

    steps:
      - name: Checkout ranobe-aniyomi
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Node
        uses: actions/setup-node@60edb5dd545a775178f52524783378180af0d1f8 # v4.2.0
        with:
          node-version: "22"

      - name: Checkout lnreader-plugins published artifacts
        run: |
          repo="https://github.com/andreykolesnikov/lnreader-plugins.git"
          plugin_branch="$(git ls-remote --heads "$repo" "refs/heads/plugins/*" | awk '{print $2}' | sed 's#refs/heads/##' | sort -V | tail -n1)"
          if [ -z "$plugin_branch" ]; then
            echo "::error::No plugins/* branch found in $repo"
            exit 1
          fi
          echo "Using lnreader-plugins branch: $plugin_branch"
          git clone --depth 1 --branch "$plugin_branch" "$repo" lnreader-plugins
          test -f "lnreader-plugins/.dist/plugins.min.json" || (echo "::error::Missing lnreader-plugins/.dist/plugins.min.json" && exit 1)
          test -d "lnreader-plugins/.js/src/plugins" || (echo "::error::Missing lnreader-plugins/.js/src/plugins" && exit 1)

      - name: Run compatibility check
        run: |
          node tools/compat/check-lnreader-plugins.js \
            --index "lnreader-plugins/.dist/plugins.min.json" \
            --plugins-dir "lnreader-plugins/.js/src/plugins" \
            --output "docs/reports/compat-data/nightly-lnreader-plugins-compat.json"

      - name: Run live smoke check
        run: |
          node tools/compat/live-smoke-lnreader-plugins.js \
            --index "lnreader-plugins/.dist/plugins.min.json" \
            --plugins-dir "lnreader-plugins/.js/src/plugins" \
            --output "docs/reports/compat-data/nightly-lnreader-plugins-live-smoke.json" \
            --timeout-ms 20000 \
            --concurrency 8

      - name: Generate override candidates from live smoke
        run: |
          node tools/compat/generate-override-candidates.js \
            --live-smoke "docs/reports/compat-data/nightly-lnreader-plugins-live-smoke.json" \
            --existing-overrides "app/src/main/assets/novel-plugin-overrides.json" \
            --output "docs/reports/compat-data/nightly-lnreader-plugin-override-candidates.json"

      - name: Upload compatibility report
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: nightly-lnreader-plugin-compat-${{ github.run_id }}
          path: |
            docs/reports/compat-data/nightly-lnreader-plugins-compat.json
            docs/reports/compat-data/nightly-lnreader-plugins-live-smoke.json
            docs/reports/compat-data/nightly-lnreader-plugin-override-candidates.json
